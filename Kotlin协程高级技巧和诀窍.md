Kotlinåç¨‹å‡ºå¥‡åœ°ç®€å•ï¼šä»…ä»…è®©ä¸€äº›é•¿æœŸè¿è¡Œçš„æ“ä½œæ”¾åœ¨launché‡Œé¢ï¼Œç„¶åå°±å¥½äº†ï¼Œæ˜¯è¿™æ ·çš„å§ï¼Ÿå¯¹äºç®€å•çš„æƒ…å†µï¼Œå½“ç„¶å¦‚æ­¤äº†ã€‚ä½†æ˜¯å¾ˆå¿«ï¼Œå¹¶å‘å’Œå¹¶è¡Œå›ºæœ‰çš„å¤æ‚æ€§å¼€å§‹ç§¯ç´¯ã€‚

å½“ä½ è¿›å…¥åç¨‹çš„å‘æ—¶ï¼Œä¸‹é¢å†…å®¹æ˜¯ä½ éœ€è¦çŸ¥é“çš„ã€‚

## å–æ¶ˆ + é˜»å¡å¼çš„ä»»åŠ¡ = ğŸ˜ˆ
æ²¡æœ‰åŠæ³•ç»•è¿‡å®ƒï¼šä½ å¿…é¡»åœ¨æŸäº›æ—¶å€™ä½¿ç”¨å¥½Javaæµã€‚ ä½¿ç”¨æµçš„ä¸€ä¸ªé—®é¢˜ï¼ˆå¾ˆå¤šğŸ˜‰ä¹‹ä¸€ï¼‰æ˜¯å®ƒä»¬é˜»å¡å½“å‰çº¿ç¨‹ã€‚ åœ¨åç¨‹ä¸–ç•Œä¸­è¿™æ˜¯ä¸ªåæ¶ˆæ¯ã€‚ ç°åœ¨ï¼Œå¦‚æœè¦å–æ¶ˆåç¨‹ï¼Œåˆ™å¿…é¡»ç­‰å¾…è¯»å–æˆ–å†™å…¥å®Œæˆåæ‰èƒ½ç»§ç»­ã€‚

ä½œä¸ºä¸€ä¸ªç®€å•çš„å¯é‡ç°ç¤ºä¾‹ï¼Œå‡è®¾æ‚¨æ‰“å¼€ä¸€ä¸ªServerSocketå¹¶ç­‰å¾…1ç§’è¶…æ—¶çš„è¿æ¥ï¼š

```kotlin
runBlocking(Dispatchers.IO) {
    withTimeout(1000) {
        val socket = ServerSocket(42)
         // æˆ‘ä»¬è¢«æ°¸è¿œåœ°å¡åœ¨è¿™é‡Œï¼Œç›´åˆ°æŸä¸ªä¸œè¥¿æ¥æ”¶ã€‚ä¸æƒ³çŸ¥é“ç­”æ¡ˆå—ï¼ŸğŸ˜œ
        socket.accept()
    }
}
```
åº”è¯¥å·¥ä½œå§ï¼Ÿ ä¸ã€‚

ç°åœ¨ä½ æ„Ÿè§‰æœ‰ç‚¹åƒè¿™æ ·ï¼šğŸ˜–ã€‚ é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ

å½“Closeable APIæ„å»ºè‰¯å¥½æ—¶ï¼Œå®ƒä»¬æ”¯æŒä»ä»»ä½•çº¿ç¨‹å…³é—­æµå¹¶ä¸”å°†é€‚å½“åœ°å¤±è´¥ã€‚

> æ³¨æ„ï¼šé€šå¸¸ï¼Œæ¥è‡ªJDKçš„APIéµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œä½†è¦æ³¨æ„ï¼Œä¸æ˜¯ä»»ä½•ç¬¬ä¸‰æ–¹Closeable APIéƒ½éµå¾ªã€‚ ä½ è¢«è­¦å‘Šè¿‡äº†ã€‚

å¤šäºsuspendCancellableCoroutineå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å–æ¶ˆåç¨‹æ—¶å¯ä»¥å…³é—­ä»»ä½•æµï¼š

```kotlin
public suspend inline fun <T : Closeable?, R> T.useCancellably(
        crossinline block: (T) -> R
): R = suspendCancellableCoroutine { cont ->
    cont.invokeOnCancellation { this?.close() }
    cont.resume(use(block))
}
```
ç¡®ä¿è¿™é€‚ç”¨äºæ‚¨æ­£åœ¨ä½¿ç”¨çš„APIï¼

ç°åœ¨æˆ‘ä»¬çš„é˜»å¡å¼çš„acceptè°ƒç”¨ï¼Œè¢«åŒ…è£…åœ¨useCancellablyä¸­ï¼Œåç¨‹å°†åœ¨è¶…æ—¶å‘ç”Ÿæ—¶å¤±è´¥ã€‚

```kotlin
runBlocking(Dispatchers.IO) {
    withTimeout(1000) {
        val socket = ServerSocket(42)

        // ä»¥`SocketException: socket closed`çˆ†ç ´äº†. è€¶!
        socket.useCancellably { it.accept() }
    }
}
```
æˆåŠŸäº†ï¼

ä½†æ˜¯å¦‚æœä½ æ ¹æœ¬ä¸æ”¯æŒå–æ¶ˆæ€ä¹ˆåŠï¼Ÿ ä»¥ä¸‹æ˜¯æ‚¨éœ€è¦æ³¨æ„çš„äº‹é¡¹ï¼š

 - å¦‚æœä½ ä½¿ç”¨åç¨‹çš„å¤–éƒ¨ç±»ä¸­çš„ä»»ä½•å®ä¾‹å±æ€§/å‡½æ•°ï¼Œå³ä½¿ä½ å–æ¶ˆäº†åç¨‹ï¼Œå®ƒä¹Ÿä¼šè¢«æ³„éœ²ã€‚ å¦‚æœæ‚¨æ­£åœ¨æ¸…ç†onDestroyä¸­çš„èµ„æºï¼Œè¿™å°¤å…¶é‡è¦ã€‚
**è§£å†³æ–¹æ³•**ï¼šå°†åç¨‹ç§»åˆ°ViewModelæˆ–å…¶ä»–éä¸Šä¸‹æ–‡ç±»å¹¶è®¢é˜…å…¶ç»“æœã€‚

- ç¡®ä¿ä½¿ç”¨Dispatchers.IOé˜»æ­¢è¿è¡Œï¼Œå› ä¸ºè¿™æ ·å¯ä»¥è®©Kotlinç•™å‡ºä¸€äº›é¢„æœŸæ— é™æœŸç­‰å¾…çš„çº¿ç¨‹ã€‚

- å°½å¯èƒ½ä½¿ç”¨suspendCancellableCoroutineï¼Œ è€Œä¸æ˜¯suspendCoroutineã€‚
---
## launch å’Œ async
ç”±äºå…³äºè¿™ä¸¤ä¸ªæ„å»ºå™¨çš„äº‰è®ºå·²ç»è¿‡æ—¶ï¼Œä½†æ˜¯æˆ‘æƒ³æˆ‘ä¼šå†æ¬¡æåŠä»–ä»¬çš„ä¸åŒç‚¹ã€‚

#### launch å¾€ä¸Šå†’å‡ºå¼‚å¸¸
å½“åç¨‹å´©æºƒæ—¶ï¼Œå…¶çˆ¶åç¨‹å°†è¢«å–æ¶ˆï¼Œä»è€Œå–æ¶ˆçˆ¶åç¨‹çš„æ‰€æœ‰å­åç¨‹ã€‚ ä¸€æ—¦æ•´ä¸ªæ ‘ä¸­çš„åç¨‹å–æ¶ˆç»“æŸï¼Œå¼‚å¸¸å°±ä¼šå‘é€åˆ°å½“å‰ä¸Šä¸‹æ–‡çš„å¼‚å¸¸å¤„ç†ç¨‹åºã€‚ åœ¨Androidä¸Šï¼Œè¿™æ„å‘³ç€æ— è®ºæ‚¨ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆè°ƒåº¦å™¨ï¼Œæ‚¨çš„åº”ç”¨*éƒ½ä¼šå´©æºƒ*ã€‚

#### async ä¿ç•™å®ƒçš„å¼‚å¸¸
è¿™æ„å‘³ç€await() æ˜¾å¼å¤„ç†æ‰€æœ‰å¼‚å¸¸ï¼Œå¹¶ä¸”å®‰ç½®CoroutineExceptionHandlerä¸ä¼šèµ·ä½œç”¨ã€‚

#### launch â€œé˜»å¡äº†â€ çˆ¶åç¨‹çš„ä½œç”¨åŸŸ
è™½ç„¶è¯¥å‡½æ•°ç«‹å³è¿”å›ï¼Œä½†åœ¨ä½¿ç”¨å†…å»ºlaunchçš„æ‰€æœ‰åç¨‹ä»¥æŸç§æ–¹å¼ç»“æŸä¹‹åï¼Œå…¶çˆ¶ä½œç”¨åŸŸæ‰ä¼šç»“æŸã€‚ è¿™æ ·ï¼Œå¦‚æœæ‚¨åªæ˜¯æƒ³ç­‰å¾…é‚£äº›åç¨‹å®Œæˆï¼Œåˆ™æ— éœ€åœ¨çˆ¶åç¨‹æœ«å°¾è°ƒç”¨æ‰€æœ‰å­jobçš„join() ã€‚

ä¸æ‚¨å¯èƒ½æœŸæœ›çš„ä¸åŒï¼Œå³ä½¿æœªè°ƒç”¨await() ï¼Œå¤–éƒ¨ä½œç”¨åŸŸä»å°†ç­‰å¾…asyncåç¨‹å®Œæˆã€‚

#### async è¿”å›ä¸€ä¸ªç»“æœ
è¿™ä¸ªéå¸¸ç®€å•ï¼šå¦‚æœä½ éœ€è¦åç¨‹çš„ç»“æœï¼Œasyncæ˜¯ä½ å”¯ä¸€çš„é€‰æ‹©ã€‚ å¦‚æœæ‚¨ä¸éœ€è¦ç»“æœï¼Œè¯·ä½¿ç”¨launchæ¥åˆ›å»ºå‰¯ä½œç”¨(æ³¨ï¼šå‡½æ•°å‰¯ä½œç”¨ï¼Œä¹Ÿå³è¿”å›å€¼)ã€‚ å¹¶ä¸”åªæœ‰åœ¨ç»§ç»­ä¹‹å‰éœ€è¦è¿™äº›å‰¯ä½œç”¨å®Œæˆæ—¶ï¼Œæ‰éœ€è¦ä½¿ç”¨join()ã€‚
#### join() å’Œ await()
join()ä¸ä¼šé‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œä½†æ˜¯await()ä¼šã€‚ ä½†æ˜¯ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œjoin()ä¼šå–æ¶ˆæ‚¨çš„åç¨‹ï¼Œè¿™æ„å‘³ç€ä¸ä¼šè°ƒç”¨æŒ‚èµ·å‡½æ•°join()ä¹‹åçš„ä»»ä½•ä»£ç ã€‚

---
### å¼‚å¸¸æ—¥å¿—
æ—¢ç„¶äº†è§£äº†å¼‚å¸¸çš„å¤„ç†æ–¹å¼ï¼ˆå…·ä½“å–å†³äºæ‚¨ä½¿ç”¨çš„æ„å»ºå™¨ï¼‰ï¼Œæ‚¨ä»ç„¶å¤„äºä¸¤éš¾å¢ƒåœ°ï¼šæ‚¨å¸Œæœ›è®°å½•å¼‚å¸¸è€Œä¸ä¼šå´©æºƒï¼ˆå› æ­¤æˆ‘ä»¬æ— æ³•ä½¿ç”¨launchï¼‰ï¼Œä½†æ‚¨ä¸æƒ³æ‰‹åŠ¨åœ°try/catchå®ƒä»¬ï¼ˆæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨asyncï¼‰ã€‚ æ‰€ä»¥è¿™è®©æˆ‘ä»¬......æ²¡æœ‰é€‰æ‹©ï¼Ÿ è°¢å¤©è°¢åœ°ä¸æ˜¯è¿™æ ·çš„ã€‚

è®°å½•å¼‚å¸¸æ˜¯CoroutineExceptionHandleræ´¾ä¸Šç”¨åœºçš„åœ°æ–¹ã€‚ ä½†é¦–å…ˆï¼Œè®©æˆ‘ä»¬èŠ±ä¸€ç‚¹æ—¶é—´æ¥äº†è§£åœ¨åç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸æ—¶å®é™…ä¸Šå‘ç”Ÿäº†ä»€ä¹ˆï¼š

1. æ•è·å¼‚å¸¸ï¼Œç„¶åé€šè¿‡Continuationæ¢å¤ã€‚
2. å¦‚æœæ‚¨çš„ä»£ç æ²¡æœ‰å¤„ç†å¼‚å¸¸ï¼Œå¹¶ä¸”å®ƒä¸æ˜¯CancellationExceptionï¼Œåˆ™é€šè¿‡å½“å‰çš„CoroutineContextè¯·æ±‚ç¬¬ä¸€ä¸ªCoroutineExceptionHandlerã€‚
3. å¦‚æœæœªæ‰¾åˆ°å¤„ç†ç¨‹åºæˆ–å®ƒæŠ¥é”™äº†ï¼Œåˆ™ä¼šå°†å¼‚å¸¸å‘é€åˆ°ç‰¹å®šå¹³å°çš„ä»£ç ã€‚
4. åœ¨JVMä¸Šï¼ŒServiceLoaderç”¨äºå®šä½å…¨å±€å¤„ç†ç¨‹åºã€‚
5. ä¸€æ—¦è°ƒç”¨äº†æ‰€æœ‰å¤„ç†ç¨‹åºæˆ–å…¶ä¸­ä¸€ä¸ªæŠ¥é”™äº†ï¼Œå°±ä¼šè°ƒç”¨å½“å‰çº¿ç¨‹çš„å¼‚å¸¸å¤„ç†ç¨‹åºã€‚
6. å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰å¤„ç†å¼‚å¸¸ï¼Œå®ƒä¼šå†’æ³¡ä¸Šå‡åˆ°çº¿ç¨‹ç»„ï¼Œæœ€ååˆ°è¾¾é»˜è®¤çš„å¼‚å¸¸å¤„ç†ç¨‹åºã€‚
7. å´©æºƒï¼

è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬æœ‰å‡ ä¸ªé€‰æ‹©ï¼š

- ä¸ºæ¯ä¸ªçº¿ç¨‹å®‰ç½®ä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œä½†è¿™æ˜¯ä¸ç°å®çš„ã€‚
- å®‰ç½®é»˜è®¤å¤„ç†ç¨‹åºï¼Œä½†æ˜¯è¿™æ ·ï¼Œä¸»çº¿ç¨‹ä¸­çš„é”™è¯¯ä¸ä¼šä½¿æ‚¨çš„åº”ç”¨ç¨‹åºå´©æºƒï¼Œå¹¶ä¸”æ‚¨å°†å¤„äºæ½œåœ¨çš„ä¸è‰¯çŠ¶æ€ã€‚
- [å°†å¤„ç†ç¨‹åºæ·»åŠ ä¸ºæœåŠ¡](https://gist.github.com/SUPERCILEX/f4b01ccf6fd4ef7ec0a85dbd59c89d6c)ï¼Œå½“ä½¿ç”¨å†…å»ºæœ‰launchçš„ä»»ä½•åç¨‹å´©æºƒæ—¶å°†è°ƒç”¨è¯¥æœåŠ¡ï¼ˆé«˜è¶…æŠ€å·§å§ï¼‰ã€‚
- ä½¿ç”¨æ‚¨è‡ªå·±çš„è‡ªå®šä¹‰ä½œç”¨åŸŸï¼Œå¸¦æœ‰é™„åŠ çš„å¤„ç†ç¨‹åºï¼Œè€Œä¸æ˜¯GlobalScopeï¼Œæˆ–è€…å°†å¤„ç†ç¨‹åºæ·»åŠ åˆ°æ‚¨ä½¿ç”¨çš„æ¯ä¸ªèŒƒå›´ï¼Œä½†è¿™å¾ˆçƒ¦äººï¼Œå¹¶ä½¿æ—¥å¿—è®°å½•æ˜¯å¯é€‰çš„è€Œä¸æ˜¯é»˜è®¤ã€‚

æœ€åä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯é¦–é€‰ï¼Œå› ä¸ºå®ƒçµæ´»ï¼ŒåŒæ—¶éœ€è¦æœ€å°‘çš„ä»£ç å’Œä¿®æ”¹ã€‚

å¯¹äºåº”ç”¨ç¨‹åºèŒƒå›´çš„ä»»åŠ¡ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å¸¦æœ‰æ—¥å¿—è®°å½•å¤„ç†ç¨‹åºçš„AppScopeã€‚ å¯¹äºä»»ä½•å…¶ä»–ä»»åŠ¡ï¼Œå½“æ—¥å¿—è®°å½•æ¯”å´©æºƒæ›´é€‚åˆæ—¶ï¼Œæ‚¨å¯ä»¥æ·»åŠ å¤„ç†ç¨‹åºã€‚

```kotlin
val LoggingExceptionHandler = CoroutineExceptionHandler { _, t ->
    Crashlytics.logException(t)
}
val AppScope = GlobalScope + LoggingExceptionHandler
```

```kotlin
class ViewModelBase : ViewModel(), CoroutineScope {
    override val coroutineContext = Job() + LoggingExceptionHandler

    override fun onCleared() = coroutineContext.cancel()
}
```
æ²¡é‚£ä¹ˆéš¾å§

### ç»“è®º
ä»»ä½•æ—¶å€™æˆ‘ä»¬å¤„ç†è¾¹ç¼˜æƒ…å†µï¼Œäº‹æƒ…ä¼šå¾ˆå¿«å˜å¾—æ··ä¹±ã€‚ æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« ï¼Œå¯ä»¥å¸®åŠ©æ‚¨äº†è§£åœ¨æ¬ ä½³æ¡ä»¶ä¸‹å¯èƒ½é‡åˆ°çš„å„ç§é—®é¢˜ï¼Œä»¥åŠæ‚¨å¯ä»¥åº”ç”¨å“ªäº›å¯èƒ½çš„è§£å†³æ–¹æ¡ˆã€‚

å¿«ä¹Kotliningï¼
